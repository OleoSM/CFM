<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CEFIMAT Asesor√≠as - Plataforma Universal</title>
    
    <!-- Librer√≠as Externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- PDF.js para leer los archivos -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <script>
        // Configuraci√≥n de Tailwind
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { primary: '#0f172a', accent: '#4f46e5' },
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    screens: { 'xs': '375px' }
                }
            }
        }
        
        // Configuraci√≥n del Worker de PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f1f5f9; 
            overscroll-behavior: none; 
            touch-action: manipulation;
            transition: background-color 0.3s ease;
        }

        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .responsive-container {
            width: 100%; height: 100%;
            display: flex; flex-direction: column;
            background: white; overflow: hidden;
            position: relative;
            transform: translateZ(0); will-change: transform;
            transition: all 0.3s ease;
        }

        @media (min-width: 768px) {
            body { display: flex; align-items: center; justify-content: center; height: 100vh; padding: 2rem; }
            .responsive-container {
                max-width: 1200px; height: 85vh; max-height: 900px;
                border-radius: 2rem;
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
                border: 1px solid rgba(226, 232, 240, 0.8);
            }
        }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; }
        
        .btn-active:active { transform: scale(0.97); opacity: 0.9; }
        .subject-card { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .subject-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        
        .diff-tag {
            font-size: 0.65rem; padding: 2px 8px; border-radius: 6px;
            font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em;
        }
        .diff-easy { background: #ecfdf5; color: #059669; }
        .diff-mid { background: #fffbeb; color: #d97706; }
        .diff-hard { background: #fef2f2; color: #dc2626; }

        /* Animaci√≥n de carga */
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #4f46e5;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-100 dark:bg-slate-950 transition-colors">

    <div id="app" class="responsive-container border-slate-200 dark:border-slate-800 dark:bg-slate-900">
        <!-- El contenido se inyecta v√≠a JS -->
    </div>

    <script type="module">
        // --- ESTADO DE LA APLICACI√ìN ---
        const state = {
            view: 'welcome',
            theme: 'light',
            userName: '',
            userGroup: '',
            subject: null,
            unit: null,
            quiz: null,
            currentQuestion: 0,
            score: 0,
            isAnswered: false,
            selectedOption: null,
            reports: [],
            isLoading: false,       // Estado de carga para el PDF
            loadingMessage: '',     // Mensaje de progreso
            loadedQuestions: []     // Preguntas cargadas del PDF actual
        };

        // --- L√ìGICA DE PROCESAMIENTO DE PDF ---

        async function extractTextFromPDF(url) {
            try {
                // Validaci√≥n b√°sica de protocolo
                if (window.location.protocol === 'file:') {
                    throw new Error("Est√°s abriendo el archivo localmente (doble clic). Necesitas usar un Servidor Local (como Live Server en VS Code) para cargar PDFs externos.");
                }

                const loadingTask = pdfjsLib.getDocument(url);
                const pdf = await loadingTask.promise;
                let fullText = "";

                for (let j = 1; j <= pdf.numPages; j++) {
                    state.loadingMessage = `Leyendo p√°gina ${j} de ${pdf.numPages}...`;
                    renderView(); 

                    const page = await pdf.getPage(j);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(s => s.str).join(" ");
                    fullText += pageText + " ";
                }
                return fullText;
            } catch (error) {
                console.error("Error PDF:", error);
                // Lanzamos el error con mensaje descriptivo para mostrarlo en la UI
                throw error; 
            }
        }

        // Funci√≥n auxiliar para quitar acentos (tildes)
        function normalizeText(text) {
            if (!text) return "";
            
            let result = "";
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                switch(char) {
                    case '√°': result += 'a'; break;
                    case '√©': result += 'e'; break;
                    case '√≠': result += 'i'; break;
                    case '√≥': result += 'o'; break;
                    case '√∫': result += 'u'; break;
                    case '√Å': result += 'A'; break;
                    case '√â': result += 'E'; break;
                    case '√ç': result += 'I'; break;
                    case '√ì': result += 'O'; break;
                    case '√ö': result += 'U'; break;
                    default: result += char; break;
                }
            }
            return result;
        }

        function parseQuizText(text) {
            const questions = [];
            
            // 1. Normalizaci√≥n y limpieza inicial (Aqu√≠ se aplican las reglas de acentos)
            let cleanText = normalizeText(text);
            cleanText = cleanText.replace(/\s+/g, " ").trim();

            // 2. Dividir por bloques de pregunta.
            // Patr√≥n: Inicio de n√∫mero seguido de ".-" (Ej: "1.- ", "2.-")
            // Agregamos '?' al espacio para ser flexibles si no hay espacio despu√©s del guion
            const questionBlocks = cleanText.split(/(?=\b\d+\.-\s?)/g);

            questionBlocks.forEach(block => {
                // Validaci√≥n estricta de estructura m√≠nima:
                // Debe tener "Num.-", y al menos los incisos A) y D)
                if (!/\d+\.-\s?/.test(block) || !block.includes("A)") || !block.includes("D)")) return;

                try {
                    // --- EXTRACCI√ìN DE LA PREGUNTA ---
                    // Separamos por el primer inciso "A)"
                    // [0] = Texto de la pregunta (incluyendo "1.-")
                    // [1] = Resto del texto (opciones)
                    const splitParts = block.split(/\s+A\)\s+/);
                    
                    if (splitParts.length < 2) return;

                    let rawQuestion = splitParts[0].trim();
                    const optionsText = splitParts[1].trim();

                    // Limpiar el n√∫mero inicial ("1.-")
                    let questionText = rawQuestion.replace(/^\d+\.-\s*/, "").trim();

                    // Limpiar los dos puntos ":" finales si existen (seg√∫n tu requerimiento)
                    if (questionText.endsWith(":")) {
                        questionText = questionText.slice(0, -1).trim();
                    }

                    // --- EXTRACCI√ìN DE LAS OPCIONES ---
                    // El texto restante son las opciones. Buscamos los separadores B), C), D)
                    // Usamos regex con espacios para evitar coincidir con texto interno
                    const parts = optionsText.split(/\s+[B-D]\)\s+/);
                    
                    // Esperamos 4 partes (A, B, C, D)
                    if (parts.length < 4) return;

                    const optA = parts[0].trim();
                    const optB = parts[1].trim();
                    const optC = parts[2].trim();
                    let optD = parts[3].trim(); // D contiene el resto hasta el final del bloque

                    // Limpieza final de la D:
                    // Si el PDF tra√≠a basura despu√©s de la D o si simplemente termina en punto
                    // El usuario indic√≥ que "termina en punto del inciso D"
                    if (optD.endsWith(".")) {
                        optD = optD.slice(0, -1).trim();
                    }

                    // --- DETECCI√ìN DE RESPUESTA CORRECTA ---
                    const optionsRaw = [optA, optB, optC, optD];
                    let correctIndex = 0; // Por defecto A si falla la detecci√≥n

                    const optionsClean = optionsRaw.map((opt, index) => {
                        // Buscamos marcas de respuesta correcta (check, palabra correcta)
                        const isCorrect = opt.includes('‚úì') || opt.includes('‚úî') || opt.toLowerCase().includes('(correcta)');
                        
                        if (isCorrect) correctIndex = index;

                        // Limpiamos la marca del texto final
                        return opt.replace(/[‚úì‚úî]/g, '').replace(/\(correcta\)/yi, '').trim();
                    });

                    questions.push({
                        q: questionText,
                        a: optionsClean,
                        c: correctIndex,
                        r: "Respuesta identificada en el material.", 
                        h: "Consulta la gu√≠a de estudio."
                    });

                } catch (e) {
                    console.warn("Error procesando bloque:", block.substring(0, 30), e);
                }
            });

            return questions;
        }

        // --- ESTRUCTURA DE DATOS (IMPORTANTE: LOS NOMBRES DEBEN COINCIDIR EXACTAMENTE) ---
        // 'folderName' y 'fileName' deben ser IGUALES al nombre de tu carpeta/archivo en Windows.
        const DATA = {
            historia_mexico: { 
                folderName: "Historia_De_Mexico", // <--- CARPETA 1: Aseg√∫rate que no tenga espacios si aqu√≠ no los tiene
                title: "H. M√©xico", 
                icon: "scroll-text", accent: "bg-emerald-600", bg: "bg-emerald-50", border: "border-emerald-200", darkBg: "dark:bg-emerald-950/40", darkBorder: "dark:border-emerald-900/60", text: "text-emerald-900 dark:text-emerald-400", 
                units: {
                    u1: { 
                        folderName: "Unidad_1", // <--- CARPETA 2
                        label: "Unidad 1: La Nueva Espa√±a", 
                        desc: "Virreinato, instituciones y mestizaje.", 
                        quizzes: {
                            q1: { fileName: "Cuestionario_1.pdf", label: "1. Mesoam√©rica", type: "easy" }, // <--- ARCHIVO PDF
                            q2: { fileName: "Cuestionario_2.pdf", label: "2. El Virreinato", type: "mid" }
                        }
                    },
                    u2: { 
                        folderName: "Unidad_2",
                        label: "Unidad 2: Independencia", 
                        desc: "Guerra de insurgencia y consumaci√≥n.", 
                        quizzes: {
                            q1: { fileName: "Cuestionario_1.pdf", label: "1. Iniciaci√≥n", type: "easy" },
                            q2: { fileName: "Cuestionario_2.pdf", label: "2. Consumaci√≥n", type: "mid" }
                        }
                    }
                }
            },
            historia_universal: { 
                folderName: "Historia_Universal",
                title: "H. Universal", icon: "globe-2", accent: "bg-indigo-600", bg: "bg-indigo-50", border: "border-indigo-200", darkBg: "dark:bg-indigo-950/40", darkBorder: "dark:border-indigo-900/60", text: "text-indigo-900 dark:text-indigo-400", 
                units: {
                    u1: { folderName: "Unidad_1", label: "Unidad 1", desc: "Conceptos b√°sicos.", quizzes: { q1: { fileName: "Cuestionario_1.pdf", label: "1. Conceptos", type: "easy" } } }
                }
            },
            biologia: { 
                folderName: "Biologia",
                title: "Biolog√≠a", icon: "dna", accent: "bg-green-600", bg: "bg-green-50", border: "border-green-200", darkBg: "dark:bg-green-950/40", darkBorder: "dark:border-green-900/60", text: "text-green-900 dark:text-green-400", 
                units: {
                    u1: { folderName: "Unidad_1", label: "Unidad 1", desc: "La C√©lula.", quizzes: { q1: { fileName: "Cuestionario_1.pdf", label: "1. C√©lula", type: "easy" } } }
                }
            }
        };

        const getHumorousPhrase = (perc) => {
            if (perc === 100) return "¬°Nivel Dios activado! üèÜ.";
            if (perc >= 85) return "¬°Impresionante! üß†üî• Casi huelo el √©xito acad√©mico.";
            if (perc >= 70) return "¬°Muy bien! ‚òï‚ú® Est√°s cerca de la iluminaci√≥n total.";
            if (perc >= 50) return "En el medio, como el jam√≥n del s√°ndwich. ü•™ ¬°A seguir!";
            if (perc >= 30) return "No est√° mal, pero hasta mi despertador tiene m√°s ritmo. ‚è∞";
            if (perc > 0) return "¬°Ups! üìöüôÉ A sacudir esas neuronas con m√°s fuerza.";
            return "Bueno... al menos pusiste bien tu nombre. üòÖ";
        };

        window.actions = {
            toggleTheme: () => {
                state.theme = state.theme === 'light' ? 'dark' : 'light';
                document.documentElement.classList.toggle('dark', state.theme === 'dark');
                initLayout();
            },
            updateInput: (id, val) => {
                state[id] = val;
                const canStart = state.userName.trim() !== '' && state.userGroup.trim() !== '';
                const helper = document.getElementById('helper-text');
                if (helper) helper.innerText = canStart ? 'SELECCIONA MATERIA' : 'INGRESA TUS DATOS PARA COMENZAR';
                document.querySelectorAll('.subject-card').forEach(btn => {
                    btn.disabled = !canStart;
                    btn.style.opacity = canStart ? "1" : "0.5";
                });
            },
            setSubject: (key) => { state.subject = key; state.view = 'units'; renderView(); },
            setUnit: (unitKey) => { state.unit = unitKey; state.view = 'quizzes'; renderView(); },
            
            startQuiz: async (quizKey) => { 
                state.quiz = quizKey;
                state.isLoading = true;
                state.loadingMessage = "Iniciando descarga...";
                renderView(); 

                const subjectData = DATA[state.subject];
                const unitData = subjectData.units[state.unit];
                const quizData = unitData.quizzes[quizKey];

                // Construimos la ruta relativa
                const filePath = `./${subjectData.folderName}/${unitData.folderName}/${quizData.fileName}`;

                console.log("Intentando cargar:", filePath);

                try {
                    state.loadingMessage = "Descargando PDF...";
                    renderView();
                    const rawText = await extractTextFromPDF(filePath);

                    state.loadingMessage = "Procesando preguntas...";
                    renderView();
                    const questions = parseQuizText(rawText);

                    if (questions.length === 0) throw new Error("No se encontraron preguntas v√°lidas (Formato 1.- ... A) ...).");

                    state.loadedQuestions = questions;
                    state.currentQuestion = 0;
                    state.score = 0;
                    state.isAnswered = false;
                    state.isLoading = false;
                    state.view = 'quiz';
                    renderView();

                } catch (error) {
                    console.error(error);
                    // IMPORTANTE: Mostramos el error en pantalla
                    alert(`ERROR DE CARGA:\n\nNo se pudo encontrar o leer el archivo:\n"${filePath}"\n\nDetalle: ${error.message}\n\n1. Verifica que la carpeta se llame EXACTAMENTE igual.\n2. Verifica que est√©s usando Live Server.`);
                    
                    state.isLoading = false;
                    state.view = 'quizzes'; 
                    renderView();
                }
            },

            handleAnswer: (idx) => {
                if (state.isAnswered || state.loadedQuestions.length === 0) return;
                state.selectedOption = idx; 
                state.isAnswered = true;
                if (idx === state.loadedQuestions[state.currentQuestion].c) state.score++;
                renderView();
            },

            nextQuestion: () => {
                if (state.currentQuestion + 1 < state.loadedQuestions.length) { 
                    state.currentQuestion++; state.isAnswered = false; renderView(); 
                } else { 
                    const perc = Math.round((state.score / state.loadedQuestions.length) * 100);
                    const quizInfo = DATA[state.subject].units[state.unit].quizzes[state.quiz];
                    state.reports.unshift({ 
                        subjectTitle: DATA[state.subject].title, 
                        unitLabel: DATA[state.subject].units[state.unit].label, 
                        quizLabel: quizInfo.label, 
                        score: state.score, 
                        total: state.loadedQuestions.length, 
                        perc: perc, 
                        date: new Date().toLocaleDateString() + ' ' + new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) 
                    });
                    state.view = 'finished'; renderView(); 
                }
            },
            reset: () => { state.view = 'welcome'; state.subject = null; state.unit = null; state.quiz = null; renderView(); },
            goToUnits: () => { state.view = 'units'; renderView(); },
            goToReports: () => { state.view = 'reports'; renderView(); }
        };

        function checkDeepLinks() {
            const params = new URLSearchParams(window.location.search);
            const subject = params.get('subject'), unit = params.get('unit'), name = params.get('name'), group = params.get('group');
            if (name) state.userName = name.replace(/_/g, ' ');
            if (group) state.userGroup = group.replace(/_/g, ' ');
            if ((subject || unit) && !state.userName) { state.userName = "Alumno Externo"; state.userGroup = "Plataforma Digital"; }
            if (subject && DATA[subject]) { state.subject = subject; state.view = 'units'; if (unit && DATA[subject].units[unit]) { state.unit = unit; state.view = 'quizzes'; } }
        }

        function initLayout() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="px-5 py-4 border-b border-slate-100 dark:border-slate-800 bg-white dark:bg-slate-900 z-20 shrink-0 transition-colors shadow-sm">
                    <div class="flex items-center justify-between gap-4">
                        <div class="flex items-center gap-3">
                            <img src="https://www.cefimat.com/images/Logoc.png" class="w-10 h-10 object-contain" alt="Logo CEFIMAT" onerror="this.src='https://www.google.com/s2/favicons?domain=cefimat.com&sz=64'">
                            <div class="text-left">
                                <h1 class="text-sm font-black text-slate-900 dark:text-white leading-none">CEFIMAT Asesor√≠as</h1>
                                <p class="text-[9px] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-tight mt-0.5">Centro F√≠sico-Matem√°tico</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-1.5">
                            <button onclick="actions.toggleTheme()" class="btn-active w-9 h-9 flex items-center justify-center bg-slate-50 dark:bg-slate-800 text-slate-600 dark:text-amber-400 rounded-xl border border-slate-200 dark:border-slate-700 transition-colors">
                                <i data-lucide="${state.theme === 'light' ? 'moon' : 'sun'}" width="16"></i>
                            </button>
                            <button onclick="actions.goToReports()" class="btn-active w-9 h-9 flex items-center justify-center bg-emerald-50 dark:bg-emerald-900/40 text-emerald-600 dark:text-emerald-400 rounded-xl border border-emerald-100 dark:border-emerald-900/50 transition-colors">
                                <i data-lucide="bar-chart-2" width="16"></i>
                            </button>
                            <button onclick="actions.reset()" class="btn-active w-9 h-9 flex items-center justify-center bg-slate-900 dark:bg-slate-700 text-white rounded-xl shadow-md transition-colors">
                                <i data-lucide="home" width="16"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div id="view-content" class="flex-1 overflow-y-auto custom-scrollbar p-6 pb-12 dark:text-slate-200 transition-colors"></div>
                <div class="px-5 py-3 border-t border-slate-100 dark:border-slate-800 bg-slate-50 dark:bg-slate-900 flex items-center justify-between shrink-0 transition-colors text-center">
                    <span class="text-[8px] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-widest">CEFIMAT ¬© 2026</span>
                    <div class="flex items-center gap-1.5"><div class="w-2 h-2 rounded-full bg-emerald-500"></div><span class="text-[8px] font-black text-emerald-600 dark:text-emerald-400 uppercase tracking-widest">Activo</span></div>
                </div>
            `;
            lucide.createIcons();
            renderView();
        }

        function renderView() {
            const container = document.getElementById('view-content');
            let html = "";

            if (state.isLoading) {
                html = `
                    <div class="flex flex-col items-center justify-center h-full space-y-6 fade-in">
                        <div class="loader"></div>
                        <div class="text-center space-y-2">
                            <p class="text-sm font-black text-slate-700 dark:text-white uppercase tracking-widest animate-pulse">Procesando Archivo</p>
                            <p class="text-[10px] text-slate-400 font-medium">${state.loadingMessage}</p>
                        </div>
                    </div>
                `;
                container.innerHTML = html;
                return;
            }

            if (state.view === 'welcome') {
                const canStart = state.userName.trim() !== '' && state.userGroup.trim() !== '';
                html = `
                    <div class="space-y-8 fade-in text-center">
                        <div class="space-y-4">
                            <div class="flex justify-center"><span class="px-4 py-1.5 rounded-full bg-indigo-600 text-white text-[9px] font-black tracking-[0.25em] shadow-lg uppercase">INGRESO A LICENCIATURA</span></div>
                            <h2 class="text-4xl md:text-5xl font-black text-slate-900 dark:text-white tracking-tight leading-none text-center">Impulsa tus <br/><span class="text-indigo-600 dark:text-indigo-400 text-5xl md:text-6xl">Resultados</span></h2>
                        </div>
                        <div class="space-y-3 max-w-sm mx-auto">
                            <input type="text" placeholder="NOMBRE COMPLETO" oninput="actions.updateInput('userName', this.value)" value="${state.userName}" class="w-full px-5 py-4 rounded-xl border border-slate-200 dark:border-slate-700 outline-none text-xs font-bold bg-slate-50 dark:bg-slate-800 dark:text-white uppercase focus:border-indigo-500 transition-colors shadow-sm text-center">
                            <input type="text" placeholder="GRUPO" oninput="actions.updateInput('userGroup', this.value)" value="${state.userGroup}" class="w-full px-5 py-4 rounded-xl border border-slate-200 dark:border-slate-700 outline-none text-xs font-bold bg-slate-50 dark:bg-slate-800 dark:text-white uppercase focus:border-indigo-500 transition-colors shadow-sm text-center">
                        </div>
                        <div class="space-y-6 pt-2">
                            <div class="flex items-center gap-3">
                                <div class="h-[1px] bg-slate-200 dark:bg-slate-800 flex-1"></div>
                                <span id="helper-text" class="text-[9px] font-black text-slate-400 dark:text-slate-500 tracking-widest uppercase text-center">${canStart ? 'SELECCIONA MATERIA' : 'INGRESA TUS DATOS PARA COMENZAR'}</span>
                                <div class="h-[1px] bg-slate-200 dark:bg-slate-800 flex-1"></div>
                            </div>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                ${Object.keys(DATA).map(key => {
                                    const m = DATA[key];
                                    const isActive = canStart;
                                    return `<button onclick="actions.setSubject('${key}')" ${!isActive ? 'disabled' : ''} class="btn-active subject-card p-5 rounded-3xl border ${m.border} ${m.bg} ${m.darkBg} ${m.darkBorder} ${isActive ? 'opacity-100' : 'opacity-50'} flex flex-col items-center gap-3 shadow-sm text-center">
                                        <div class="w-12 h-12 rounded-2xl flex items-center justify-center text-white ${m.accent} shadow-md"><i data-lucide="${m.icon}" width="20"></i></div>
                                        <span class="font-bold ${m.text} text-[11px] uppercase">${m.title}</span>
                                    </button>`;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }

            else if (state.view === 'units') {
                const m = DATA[state.subject];
                html = `
                    <div class="space-y-8 fade-in text-center">
                        <button onclick="actions.reset()" class="text-slate-400 font-bold text-[10px] uppercase tracking-widest flex items-center gap-2 mx-auto"><i data-lucide="chevron-left" width="16"></i> Men√∫ Principal</button>
                        <div class="space-y-3">
                            <div class="w-16 h-16 ${m.accent} rounded-3xl mx-auto flex items-center justify-center text-white shadow-xl"><i data-lucide="${m.icon}" width="28"></i></div>
                            <h2 class="text-3xl font-black text-slate-900 dark:text-white uppercase">${m.title}</h2>
                        </div>
                        <div class="space-y-4 text-left max-w-xl mx-auto">
                            ${Object.keys(m.units).map(key => `
                                <button onclick="actions.setUnit('${key}')" class="btn-active w-full p-6 rounded-3xl border border-slate-100 dark:border-slate-800 bg-white dark:bg-slate-900 flex flex-col shadow-sm">
                                    <div class="flex items-center gap-4 mb-2">
                                        <div class="w-8 h-8 rounded-full bg-slate-50 dark:bg-slate-800 text-slate-400 flex items-center justify-center shrink-0"><i data-lucide="layers" width="14"></i></div>
                                        <span class="font-extrabold text-slate-900 dark:text-slate-100 uppercase text-xs">${m.units[key].label}</span>
                                    </div>
                                    <p class="text-[10px] font-medium text-slate-500 pl-12">${m.units[key].desc}</p>
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            else if (state.view === 'quizzes') {
                const unit = DATA[state.subject].units[state.unit];
                html = `
                    <div class="space-y-8 fade-in text-center">
                        <button onclick="actions.goToUnits()" class="text-slate-400 font-bold text-[10px] uppercase tracking-widest flex items-center gap-2 mx-auto"><i data-lucide="chevron-left" width="16"></i> Unidades</button>
                        <h2 class="text-2xl font-black text-slate-900 dark:text-white uppercase">${unit.label}</h2>
                        <div class="grid gap-3 max-w-lg mx-auto">
                            ${Object.keys(unit.quizzes).map(key => {
                                const q = unit.quizzes[key];
                                return `
                                    <button onclick="actions.startQuiz('${key}')" class="btn-active w-full p-5 rounded-2xl border border-slate-100 dark:border-slate-800 bg-white dark:bg-slate-900 flex items-center justify-between shadow-sm">
                                        <div class="flex flex-col text-left">
                                            <span class="font-black text-slate-900 dark:text-slate-100 uppercase text-xs">${q.label}</span>
                                            <div class="flex items-center gap-1 text-[9px] font-bold text-slate-400 uppercase mt-1">
                                                <i data-lucide="file-text" width="10"></i> ${q.fileName}
                                            </div>
                                        </div>
                                        <span class="diff-tag diff-${q.type}">${q.type}</span>
                                    </button>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }

            else if (state.view === 'quiz') {
                const total = state.loadedQuestions.length;
                const q = state.loadedQuestions[state.currentQuestion];
                html = `
                    <div class="space-y-6 fade-in">
                        <div class="flex items-center justify-between bg-slate-50 dark:bg-slate-900 p-5 rounded-3xl">
                            <div class="space-y-1.5">
                                <span class="text-[9px] font-black text-slate-400 uppercase">PROGRESO ${state.currentQuestion + 1}/${total}</span>
                                <div class="w-40 h-1.5 bg-slate-200 dark:bg-slate-800 rounded-full overflow-hidden">
                                    <div class="h-full bg-indigo-500" style="width: ${((state.currentQuestion + 1) / total) * 100}%"></div>
                                </div>
                            </div>
                            <div class="bg-white dark:bg-slate-800 px-4 py-2 rounded-xl shadow-sm border border-slate-100"><span class="text-[12px] font-black">${state.score} PTS</span></div>
                        </div>
                        <div class="p-4 bg-amber-50 dark:bg-amber-950/30 rounded-2xl text-amber-700 text-[10px] font-bold border border-amber-200 flex items-start gap-3">
                            <i data-lucide="lightbulb" width="16" class="text-amber-500 shrink-0"></i>
                            <span><span class="uppercase font-black mr-1">Nota:</span> ${q.h}</span>
                        </div>
                        <h3 class="text-xl font-black text-slate-900 dark:text-white leading-snug text-center">${q.q}</h3>
                        <div class="grid gap-3">
                            ${q.a.map((opt, i) => {
                                let style = "border-slate-200 bg-white dark:bg-slate-900 dark:border-slate-800";
                                if (state.isAnswered) {
                                    if (i === q.c) style = "border-emerald-500 bg-emerald-50 dark:bg-emerald-950/50 border-2";
                                    else if (i === state.selectedOption) style = "border-red-500 bg-red-50 dark:bg-red-950/50 border-2";
                                }
                                return `<button onclick="actions.handleAnswer(${i})" ${state.isAnswered ? 'disabled' : ''} class="btn-active p-5 rounded-2xl text-left border font-bold text-[12px] ${style} transition-all">${opt}</button>`;
                            }).join('')}
                        </div>
                        ${state.isAnswered ? `<button onclick="actions.nextQuestion()" class="btn-active w-full bg-slate-900 text-white p-5 rounded-2xl font-black uppercase text-[11px] tracking-widest shadow-xl">Siguiente Pregunta</button>` : ''}
                    </div>
                `;
            }

            else if (state.view === 'finished') {
                const total = state.loadedQuestions.length;
                const perc = Math.round((state.score / total) * 100);
                html = `
                    <div class="text-center space-y-8 py-8 fade-in">
                        <div class="w-24 h-24 bg-slate-100 dark:bg-slate-900 rounded-[2.5rem] flex items-center justify-center mx-auto shadow-inner border border-slate-200"><i data-lucide="award" width="48" class="text-slate-900 dark:text-amber-400"></i></div>
                        <div class="space-y-2">
                            <h2 class="text-4xl font-black text-slate-900 dark:text-white uppercase">¬°LOGRADO!</h2>
                            <p class="text-slate-400 font-bold uppercase text-[10px]">${state.userName}</p>
                        </div>
                        <div class="bg-white dark:bg-slate-900 p-8 rounded-[2.5rem] border border-slate-100 dark:border-slate-800 shadow-xl mx-2">
                            <span class="block text-[9px] font-black text-slate-400 uppercase mb-4">RESULTADO FINAL</span>
                            <div class="flex items-end justify-center gap-2">
                                <span class="text-7xl font-black text-slate-900 dark:text-white leading-none">${state.score}</span>
                                <span class="text-2xl font-bold text-slate-200 dark:text-slate-700 mb-2">/ ${total}</span>
                            </div>
                            <div class="mt-6 space-y-4">
                                <div class="w-full h-2 bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden"><div class="h-full bg-indigo-500" style="width: ${perc}%"></div></div>
                                <span class="text-xs font-black">${perc}% EFECTIVIDAD</span>
                            </div>
                            <div class="mt-8 p-5 bg-indigo-50 dark:bg-indigo-900/30 rounded-3xl border-2 border-indigo-100">
                                <p class="text-[11px] font-bold text-indigo-700 dark:text-indigo-300 italic">"${getHumorousPhrase(perc)}"</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 px-2">
                            <button onclick="actions.goToReports()" class="btn-active w-full bg-slate-100 text-slate-900 p-5 rounded-2xl font-black text-[10px] uppercase shadow-sm">Historial</button>
                            <button onclick="actions.reset()" class="btn-active w-full bg-slate-900 text-white p-5 rounded-2xl font-black text-[10px] uppercase shadow-xl">Inicio</button>
                        </div>
                    </div>
                `;
            }

            else if (state.view === 'reports') {
                html = `
                    <div class="space-y-8 fade-in">
                        <div class="flex items-center justify-between">
                            <button onclick="actions.reset()" class="text-slate-400 font-bold text-[10px] uppercase tracking-widest flex items-center gap-2"><i data-lucide="chevron-left" width="16"></i> Men√∫</button>
                            <span class="text-[10px] font-black uppercase">Historial</span>
                        </div>
                        <div class="space-y-4">
                            ${state.reports.length === 0 ? '<p class="text-center text-slate-400 text-xs py-20">No hay registros a√∫n.</p>' : 
                            state.reports.map(rep => `
                                <div class="bg-white dark:bg-slate-900 p-4 rounded-2xl border border-slate-100 dark:border-slate-800 shadow-sm flex items-center justify-between">
                                    <div>
                                        <div class="flex items-center gap-2"><span class="text-[10px] font-black uppercase">${rep.quizLabel}</span><span class="text-[7px] text-slate-400">${rep.date}</span></div>
                                        <div class="text-xs font-bold text-slate-500">${rep.subjectTitle} - ${rep.unitLabel}</div>
                                    </div>
                                    <div class="text-right"><span class="text-xl font-black">${rep.score}</span><span class="text-[9px] text-slate-400">/${rep.total}</span></div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
            lucide.createIcons(container);
            container.scrollTop = 0;
        }

        window.onload = () => {
            checkDeepLinks();
            initLayout();
        };
    </script>
</body>
</html>